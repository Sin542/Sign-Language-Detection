<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Text to Animation</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif;
    }
    body {
      background: url("{{ url_for('static', filename='images/sign4.png') }}") no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 30px;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px 40px;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 600px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    h2 {
      margin-bottom: 20px;
      font-weight: 600;
    }
    .email-display {
      margin-bottom: 20px;
      font-size: 14px;
      color: #666;
    }
    textarea {
      width: 100%;
      height: 100px;
      padding: 10px 15px;
      border: 1.5px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 25px;
      resize: vertical;
    }
    .btn-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .btn-row button {
      flex: 1 1 150px;
      padding: 12px 0;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    .btn-animate {
      background-color: #007bff;
      color: white;
    }
    .btn-animate:hover {
      background-color: #0056b3;
    }
    .btn-back {
      background-color: #6c757d;
      color: white;
    }
    .btn-back:hover {
      background-color: #565e64;
    }
    model-viewer, .gif-viewer {
      width: 100%;
      height: 350px;
      margin: 15px 0;
      background: #eee;
      border-radius: 12px;
      display: none;
    }
    .animation-box {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 12px;
      min-height: 60px;
      font-style: italic;
      color: #444;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>TEXT TO ANIMATION</h2>
    <p class="email-display">Logged in as: <span id="userEmail">{{ username | default('example@example.com') }}</span></p>

    <textarea id="textInput" placeholder="Enter text to animate (e.g., Thank you)"></textarea>

    <div class="btn-row">
      <button class="btn-animate" onclick="startAnimation()">Animate</button>
      <button class="btn-back" onclick="goBack()">Back to Home</button>
    </div>

    <!-- Avatar Viewer (GLB) -->
    <model-viewer id="avatarViewer"
      autoplay
      auto-rotate
      camera-controls
      shadow-intensity="1"
      ar
      ar-modes="webxr scene-viewer quick-look">
    </model-viewer>

    <!-- GIF Viewer -->
    <img id="gifViewer" class="gif-viewer" alt="Sign animation" />

    <div class="animation-box" id="animationBox">
      Animation will appear here...
    </div>
  </div>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <script>
    function goBack() {
      window.location.href = "{{ url_for('home') }}";
    }

    let animationFiles = { gifs: [], glbs: [] };

    async function fetchAnimationFiles() {
      try {
        const res = await fetch('/get_animation_files');
        if (res.ok) {
          animationFiles = await res.json();
          console.log("Available animation files:", animationFiles);
        } else {
          console.error("Failed to fetch animation files");
        }
      } catch (err) {
        console.error("Error fetching animation files:", err);
      }
    }

    function normalizeText(text) {
      return text.toLowerCase().replace(/_/g, ' ').trim();
    }

    function findMatchingFile(userInput, files) {
      userInput = userInput.toLowerCase().trim();
      for (const file of files) {
        const name = normalizeText(file.replace(/\.(gif|glb)$/i, ''));
        if (userInput.includes(name) || name.includes(userInput)) {
          return file;
        }
      }
      return null;
    }

    async function startAnimation() {
      const inputText = document.getElementById("textInput").value.trim().toLowerCase();
      const avatarViewer = document.getElementById("avatarViewer");
      const gifViewer = document.getElementById("gifViewer");
      const animationBox = document.getElementById("animationBox");

      avatarViewer.style.display = "none";
      gifViewer.style.display = "none";

      if (!inputText) {
        alert("Please enter text to animate.");
        animationBox.textContent = "Animation will appear here...";
        return;
      }

      const matchedGlb = findMatchingFile(inputText, animationFiles.glbs);
      const matchedGif = findMatchingFile(inputText, animationFiles.gifs);

      if (!matchedGlb && !matchedGif) {
        animationBox.textContent = `No matching animation found for: "${inputText}"`;
        return;
      }

      animationBox.textContent = `Animating for input: "${inputText}"`;

      if (matchedGlb) {
        avatarViewer.setAttribute('src', `/static/avatars/${encodeURIComponent(matchedGlb)}`);
        avatarViewer.setAttribute('animation-name', '*');
        avatarViewer.setAttribute('autoplay', true);
        avatarViewer.style.display = "block";
      }

      if (matchedGif) {
        gifViewer.src = `/static/avatars/${encodeURIComponent(matchedGif)}`;
        gifViewer.style.display = "block";
      }

      fetch('/log_animation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ sign: inputText })
      })
      .then(res => res.json())
      .then(data => console.log("Animation logged:", data))
      .catch(err => console.error("Error logging animation:", err));
    }

    window.onload = fetchAnimationFiles;
  </script>
</body>
</html>
